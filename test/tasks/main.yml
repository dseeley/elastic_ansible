---

- name: Ensure the health status is green for all nodes in the cluster
  uri:
    url: "http://localhost:9200/_cluster/health"
    #    user: "{{es_username}}"
    #    password: "{{es_password[buildenv]}}"
    #    force_basic_auth: yes
    method: GET
    validate_certs: no
  register: es_health
  any_errors_fatal: true
  until: >
    es_health.json is defined and
    es_health.json.status=='green' and
    es_health.json.initializing_shards==0 and
    es_health.json.number_of_nodes==cluster_hosts_state | length and
    es_health.json.number_of_data_nodes==cluster_hosts_state | json_query('[?tagslabels.hosttype==`es-data`]') | length and
    es_health.json.relocating_shards==0 and
    es_health.json.unassigned_shards==0 and
    es_health.json.delayed_unassigned_shards==0
  retries: 1000
  run_once: true
